# -*- mode: ruby -*-
# vi: set ft=ruby :

# 클러스터 설정
CLUSTER_NAME = "k8s-ubuntu2204-cephadm"

# OSD 설정
OSD_CONFIG = {
  :num => 3,           # 노드당 OSD 디스크 수
  :size => 6,         # OSD 디스크 크기 (GB)
  :start_letter => 'b' # OSD 디스크 시작 문자
}

# 노드 설정
K8S_CLUSTER = {
  #"k8s-nfs" => { :ip => "172.16.10.100", :cpus => 2, :memory => 1000, :ssh => 22200 },
  "k8s-master" => { :ip => "172.16.10.10", :cpus => 4, :memory => 4000, :ssh => 22000, :role => "master" },
  "k8s-worker1" => { :ip => "172.16.10.21", :cpus => 2, :memory => 3000, :ssh => 22001, :role => "worker" },
  "k8s-worker2" => { :ip => "172.16.10.22", :cpus => 2, :memory => 3000, :ssh => 22002, :role => "worker" },
  "k8s-worker3" => { :ip => "172.16.10.23", :cpus => 2, :memory => 3000, :ssh => 22003, :role => "worker" }
}

DISK_PATH = "C:/VirtualBox VMs/#{CLUSTER_NAME}/disk-"

Vagrant.configure("2") do |config|
  # 공통 설정
  config.vm.box = "bento/ubuntu-22.04"
  config.vm.provision "shell", inline: "sudo apt-get update -y"

  K8S_CLUSTER.each do |hostname, node|
    config.vm.define hostname do |machine|
      # 필수 호스트명 설정 추가
      machine.vm.hostname = hostname
      
      # 네트워크 설정 보완
      machine.vm.network "private_network", ip: node[:ip]
      machine.vm.network "forwarded_port", 
        guest: 22, 
        host: node[:ssh], 
        id: "ssh", 
        auto_correct: true  # auto_correct 옵션 추가

      # 환경변수 설정 수정
      machine.vm.provision "shell", inline: <<-SHELL
        sudo sh -c "echo 'export CLUSTER_NAME=#{CLUSTER_NAME}' > /etc/profile.d/ceph-config.sh"
        sudo sh -c "echo 'export HOST_COUNT=#{K8S_CLUSTER.size}' >> /etc/profile.d/ceph-config.sh"
        sudo sh -c "echo 'export OSD_NUM=#{OSD_CONFIG[:num]}' >> /etc/profile.d/ceph-config.sh"
        sudo sh -c "echo 'export OSD_SIZE=#{OSD_CONFIG[:size]}' >> /etc/profile.d/ceph-config.sh"
        sudo sh -c "echo 'export OSD_START_LETTER=#{OSD_CONFIG[:start_letter]}' >> /etc/profile.d/ceph-config.sh"
        sudo sh -c "echo 'export NODE_ROLE=#{node[:role]}' >> /etc/profile.d/ceph-config.sh"
        sudo sh -c "echo 'export BASE_IP=\"172.16.10.10\"' >> /etc/profile.d/ceph-config.sh"
        sudo sh -c "echo 'export NODE_IP=#{node[:ip]}' >> /etc/profile.d/ceph-config.sh"
        sudo chmod +x /etc/profile.d/ceph-config.sh
      SHELL

      # VirtualBox 제공자 설정 보완
      machine.vm.provider "virtualbox" do |vb|
        vb.name = hostname
        vb.gui = false
        vb.memory = node[:memory].to_i  # 숫자 타입 변환
        vb.cpus = node[:cpus].to_i
        
        # 그룹 및 하드웨어 설정
        vb.customize ["modifyvm", :id, "--groups", "/#{CLUSTER_NAME}"]
        vb.customize ["modifyvm", :id, "--ioapic", "on"]
        
        # 디스크 설정 개선
        if OSD_CONFIG[:num] > 0
          # 디스크 저장 경로 생성
          FileUtils.mkdir_p(File.dirname(DISK_PATH)) unless File.directory?(File.dirname(DISK_PATH))
          
          OSD_CONFIG[:num].times do |i|
            disk_path = "#{DISK_PATH}#{hostname}-#{i+1}.vdi"
            
            vb.customize [
              'createhd', 
              '--filename', disk_path.tr('/', '\\'),  # Windows 경로 변환
              '--size', "#{OSD_CONFIG[:size] * 1024}"
            ]
            
            # 스토리지 연결 설정
            vb.customize [
              'storageattach', :id,
              '--storagectl', 'SATA Controller',
              '--port', "#{i+1}",
              '--device', '0',
              '--type', 'hdd',
              '--medium', disk_path.tr('/', '\\')  # Windows 경로 변환
            ]
          end
        end
      end

      # 호스트 파일 설정을 위한 공통 스크립트
      machine.vm.provision "shell", inline: <<-SHELL
        # 호스트 파일 설정 - 모든 클러스터 노드에 추가
        sudo sed -i '/k8s-master/d' /etc/hosts
        sudo sed -i '/k8s-worker/d' /etc/hosts

        sudo sh -c "echo '172.16.10.10 k8s-master' >> /etc/hosts"
        sudo sh -c "echo '172.16.10.21 k8s-worker1' >> /etc/hosts"
        sudo sh -c "echo '172.16.10.22 k8s-worker2' >> /etc/hosts"
        sudo sh -c "echo '172.16.10.23 k8s-worker3' >> /etc/hosts"
      SHELL

      # 노드별 스크립트 실행 (hostname 기준으로 조건 확인)
      machine.vm.provision "shell", path: "scripts/k8s-setup.sh", privileged: false
      machine.vm.provision "shell", path: "scripts/ceph-node.sh", privileged: false
      if hostname == "k8s-master"
        machine.vm.provision "shell", path: "scripts/ceph-bootstrap.sh", privileged: false
        machine.vm.provision "shell", path: "scripts/ceph-storage-setup.sh", privileged: false
      end
    end
  end
end